#!/usr/bin/env python

import pyodbc
import sys

# Thresholds
WARNING = 80
CRITICAL = 90

try:
    conn = pyodbc.connect(
        "DRIVER={ODBC Driver 17 for SQL Server};"
        "SERVER=DB_SERVER,11580;"
        "DATABASE=master;"
        "UID=username;"
        "PWD=password;",
        timeout=5
    )

    cursor = conn.cursor()
    cursor.execute("""
        SELECT TOP 1
            record.value('(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]', 'int')
        FROM sys.dm_os_ring_buffers
        WHERE ring_buffer_type = 'RING_BUFFER_SCHEDULER_MONITOR'
        AND record LIKE '%<SystemHealth>%'
        ORDER BY timestamp DESC
    """)

    cpu = cursor.fetchone()[0]

    if cpu >= CRITICAL:
        print(f"CRITICAL - SQL Server CPU usage is {cpu}%")
        sys.exit(2)
    elif cpu >= WARNING:
        print(f"WARNING - SQL Server CPU usage is {cpu}%")
        sys.exit(1)
    else:
        print(f"OK - SQL Server CPU usage is {cpu}%")
        sys.exit(0)

except Exception as e:
    print(f"UNKNOWN - Error checking SQL CPU: {e}")
    sys.exit(3)
